{% extends 'main/layout.html' %}


{% block title%}{{ page_name }}{% endblock %}
{% load price_system_util %}
{% block content%}
    <div class="features">
        <div class="top-befor-header">
            <h1>{{ page_name }}</h1>
        </div>
        <div class='filter-data'>
            <form action="" class="small-filter-form" method="POST">
                {% csrf_token %}
                <label for="common_article_id" class="rand">
                    <span>Артикул</span><br>
                    <input type="text" id="common_article_id" name="common_article" class="input-field">
                </label>
                <label for="designer" class="rand">
                    <span>Автор</span><br>
                    <select id="designer" name="designer">
                        <option value=""></option>
                        {% for designer in designer_list %}
                            <option value="{{ designer.id }}">{{ designer.username }}</option>
                        {% endfor %}
                    </select>
                </label>
                <div class="inner-form-data">
                    <br>
                    <input type="Submit" id="filter" name="filter" value="Фильтровать" />
                </div>
                <div>
                    <br>
                    <input type="checkbox" id="articles_without_designer" name="checkbox_value" value="true">
                    <label for="articles_without_group">Артикул без дизайнера</label>
                </div>
                <div class="inner-form-data">
                    <br>
                    <input type="Submit" id="filter" name="filter_data" value="ООО Иннотрейд" />
                </div>
                <div class="inner-form-data">
                    <br>
                    <input type="Submit" id="filter" name="filter_data" value="ИП Караваев" />
                </div>
                
            </form>
        </div>
        <table id="table" style="overflow-x: scroll; display: block;">
            <tr>
                <th rowspan="2">Ночник</th>
                <th rowspan="2">Автор</th>
                <th rowspan="2">Продажи за год</th>
                <th rowspan="2">Вознаграждение</th>
                <th colspan="{{ month_list|length }}">{{ current_year }} год</th>
            </tr>
            <tr>
                {% for month in month_list %}
                    <th>{{ month }}</th>
                {% endfor %}
            </tr>
            
            {% for el in article_list %}
            <tr>
                <td>{{ el.common_article }}</td>
                
                    <td>
                        <select class="mySelect" data-row="{{ el.common_article }}">
                            {% if el.designer != None %}
                                <option value="">{{ el.designer }}</option>
                            {% else %}
                                <option value=""></option>
                            {% endif %}
                            {% for designer in designer_list %}
                                <option value="{{ designer.id }}">{{ designer.username }}</option>
                            {% endfor %}
                        </select>
                    </td>
                
                <td>{{year_sales_dict|get_item:el.id}}</td>
                <td>{{year_sales_dict|get_item:el.id|multiplicity:0.02}}</td>
                {% for month in month_list %}
                    {% if main_sales_dict|get_item:el.id|get_item:month %}
                        <td>{{ main_sales_dict|get_item:el.id|get_item:month }}</td>
                    {% else %}
                        <td></td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>    
    <script>
        document.querySelectorAll('.mySelect').forEach(select => {
            select.addEventListener('change', function() {
                var selectedSurname = this.value;
                console.log(selectedSurname)
                var rowNumber = this.dataset.row;
                console.log(rowNumber)

                var formData = new FormData();
                formData.append('selected_designer', selectedSurname);
                formData.append('article', rowNumber);
                formData.append('csrfmiddlewaretoken', document.querySelector('input[name="csrfmiddlewaretoken"]').value);
            
                fetch('update_model_field/', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => {
                    if (response.ok) {
                        // Обработка успешного ответа от сервера
                        // Например, обновление отображаемого значения фамилии в таблице
                    } else {
                        // Обработка ошибки
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });


        document.getElementById('articles_without_designer').addEventListener('change', function() {
            let table_n = document.getElementById("table");
            let rows_n = table_n.getElementsByTagName("tr");
            if (document.getElementById('articles_without_designer').checked) {
                for (let i = 0; i < rows_n.length; i++) {
                    let input = rows_n[i].querySelector('select');
                    if (input) {
                        let an_input = input.options[0]
                        if (an_input){
                            if(an_input.innerText){
                                rows_n[i].style.display = 'none';
                            } else {
                                rows_n[i].style.display = '';
                            }
                        };
                    }}
            } else {
                for (let i = 0; i < rows_n.length; i++) {
                    let input = rows_n[i].querySelectorAll('select');
                    input.forEach((input) => {
                        rows_n[i].style.display = '';
                    })
                }
            }
        });
    </script>
        
{% endblock %}
